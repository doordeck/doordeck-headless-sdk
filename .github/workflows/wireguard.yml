name: Setup WireGuard

on:
  workflow_call:
    inputs:
      wireguard_type:
        required: true
        type: string
    secrets:
      WIREGUARD_PRIVATE_KEY:
        required: true
      WIREGUARD_INTERFACE_ADDRESS:
        required: true
      WIREGUARD_PEER_PUBLIC_KEY:
        required: true
      WIREGUARD_PEER_ALLOWED_IPS:
        required: true
      WIREGUARD_PEER_ENDPOINT:
        required: true

jobs:
  wireguard-ubuntu:
    runs-on: ubuntu-latest
    steps:
      - name: Setup WireGuard (ubuntu)
        if: inputs.wireguard_type == 'wireguard-ubuntu'
        run: |
          # Install
          sudo apt install wireguard -y

          # Config
          sudo mkdir -p /etc/wireguard/
          echo "[Interface]" | sudo tee /etc/wireguard/wg0.conf > /dev/null
          echo "PrivateKey = ${{ secrets.WIREGUARD_PRIVATE_KEY }}" | sudo tee -a /etc/wireguard/wg0.conf > /dev/null
          echo "Address = ${{ secrets.WIREGUARD_INTERFACE_ADDRESS }}" | sudo tee -a /etc/wireguard/wg0.conf > /dev/null
          echo "[Peer]" | sudo tee -a /etc/wireguard/wg0.conf > /dev/null
          echo "PublicKey = ${{ secrets.WIREGUARD_PEER_PUBLIC_KEY }}" | sudo tee -a /etc/wireguard/wg0.conf > /dev/null
          echo "AllowedIPs = ${{ secrets.WIREGUARD_PEER_ALLOWED_IPS }}" | sudo tee -a /etc/wireguard/wg0.conf > /dev/null
          echo "Endpoint = ${{ secrets.WIREGUARD_PEER_ENDPOINT }}" | sudo tee -a /etc/wireguard/wg0.conf > /dev/null

          # Enable interface
          sudo wg-quick up wg0

  wireguard-macos:
    runs-on: macos-latest
    steps:
      - name: Setup WireGuard (macOS)
        if: inputs.wireguard_type == 'wireguard-macos'
        run: |
          # Install
          brew install wireguard-tools wireguard-go

          # Config
          sudo mkdir -p /usr/local/etc/wireguard
          cat <<EOF | sudo tee /usr/local/etc/wireguard/wg0.conf > /dev/null
          [Interface]
          PrivateKey = ${{ secrets.WIREGUARD_PRIVATE_KEY }}
          Address = ${{ secrets.WIREGUARD_INTERFACE_ADDRESS }}
          [Peer]
          PublicKey = ${{ secrets.WIREGUARD_PEER_PUBLIC_KEY }}
          AllowedIPs = ${{ secrets.WIREGUARD_PEER_ALLOWED_IPS }}
          Endpoint = ${{ secrets.WIREGUARD_PEER_ENDPOINT }}
          EOF

          # Enable interface
          sudo chmod 600 /usr/local/etc/wireguard/wg0.conf
          sudo wg-quick up /usr/local/etc/wireguard/wg0.conf

  wireguard-windows:
    runs-on: windows-latest
    steps:
      - name: Setup WireGuard (windows)
        if: inputs.wireguard_type == 'wireguard-windows'
        shell: powershell
        run: |
          # Install
          choco install wireguard -y --force

          # Config
          $configFile = @"
          [Interface]
          PrivateKey = ${{ secrets.WIREGUARD_PRIVATE_KEY }}
          Address = ${{ secrets.WIREGUARD_INTERFACE_ADDRESS }}
          [Peer]
          PublicKey = ${{ secrets.WIREGUARD_PEER_PUBLIC_KEY }}
          AllowedIPs = ${{ secrets.WIREGUARD_PEER_ALLOWED_IPS }}
          Endpoint = ${{ secrets.WIREGUARD_PEER_ENDPOINT }}
          "@
          Set-Content -Path C:\Temp\wg0.conf -Value $configFile

          # Enable interface
          & "C:\Program Files\WireGuard\wireguard.exe" /installtunnelservice C:\Temp\wg0.conf